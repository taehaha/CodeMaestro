###############################
# Stage 1: 빌드 단계 (builder)
###############################
FROM node:20-alpine as builder

# Alpine 이미지에서 envsubst 사용을 위해 gettext 설치
RUN apk add --no-cache gettext

# 빌드 인자 선언
ARG REACT_APP_FRONTEND_URL
ARG REACT_APP_BACKEND_URL
ARG REACT_APP_CONCURRENCY_BACKEND_URL
ARG REACT_APP_CONCURRENCY_BACKEND_WEBSOCKET_URL
ARG OPENAI_API_KEY

WORKDIR /app

# 소스 코드 복사
COPY . .

# .env.template 파일을 기반으로 .env 파일 생성 (envsubst 사용)
RUN envsubst < .env.template > .env

# 나머지 빌드 작업
RUN yarn install --frozen-lockfile
RUN yarn build-all

RUN yarn install --production --frozen-lockfile

###############################
# Stage 2: 최종 실행 단계 (runner)
###############################
FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app /app

EXPOSE 3000
CMD ["yarn", "start-server"]
